---
title: "Decoding the Price Tag: How do various factors influence truck pricing
across different weight categories?"
author: "Marina Bazano Sammartino (283481), Mateusz Mandziuk (254303)"
date: "`r format(Sys.time(), '%m/%d/%Y %X')`"
output:
  rmdformats::readthedown:
    highlight: kate
    number_sections: true
    self_contained: true
---

```{r setup, include=FALSE}
## Global options
library(knitr)
opts_chunk$set(echo = TRUE,
               cache = FALSE,
               prompt = FALSE,
               tidy = TRUE,
               comment = NA,
               message = FALSE,
               warning = FALSE,
               fig.width = 7.4,
               fig.height = 4.7,
               fig.align = "center")
opts_knit$set(width = 80)
```
# Problem Description
<div style="text-align: justify">
The transportation sector is one of the key segments of Poland's economy, with around 7% of its GDP directly linked to transport.[^1] Moreover, around 20% of all UE transport was fulfilled by Poland-based companies[^2], serving as a backbone for trade, logistics, and supply chain management on the continent. With Poland's strategic location as a transit hub in Europe, the demand for commercial vehicles, particularly trucks, is significant and continuously growing[^3]. This dynamic market comprises a wide range of vehicles designed to meet the needs of various industries, from local deliveries to long-haul transportation. Understanding the pricing mechanisms within each segment is essential for car dealerships, manufacturers, transport companies, and all the other stakeholders.  

This report aims to uncover how various truck parameters, such as engine capacity, vehicle age, brand, model, and other factors, affect the pricing of trucks within different segments of the market. Specifically, the study seeks to answer questions about which factors most significantly influence truck prices in the light, medium, and heavy commercial vehicle categories. The core of this student project lies in applying web scraping techniques and leveraging the R programming language to collect and analyze real-world data. The data is sourced from Otomoto[^4], a popular Polish platform for listing second-hand vehicles. By scraping detailed truck listings from this service, the project ensures access to a rich data set that reflects the current market trends and truck offerings.  
  
By analyzing these factors, the goal is to offer actionable insights for businesses, fleet managers, and individual buyers looking to optimize their purchasing decisions or fleet management strategies. This study leverages data analytics techniques to identify the key price determinants in the truck market. Ultimately, this research will enhance our understanding of how trucks are priced across various weight categories, helping stakeholders make more informed decisions when navigating the truck market.
</div>

# Objectives
 This report aims to fulfill 3 main objectives:  
 
- **Understand the key characteristics of trucks available for sale**: This includes mileage, fuel type, transmission, engine capacity, power, and origin.  
- **Evaluate market trends**: Identify patterns in the year of production, popular brands and common features.
- **Determining price elements**: Discover what are key elements explaining the price of the truck.  

</div>

# Data
<div style="text-align: justify">
The dataset for this analysis was collected using a custom **web scraper** written in **R**, which specifically targeted the **Otomoto website**, a popular marketplace for vehicle sales in Poland. The scraper was designed to extract detailed information about truck offers, with a focus on the **Mazowieckie Voivodeship**.
</div>

```r
# Example URL structure for scraping listings
url_base <- "https://www.otomoto.pl/ciezarowe/mazowieckie?search%5Bfilter_enum_damaged%5D=0&page="
```
- **`mazowieckie`** specifies the voivodeship (region).
- **`filter_enum_damaged=0`** ensures that only undamaged trucks are included.
- Pagination was handled by iterating over the page parameter (from **1 to 70**), ensuring all results were captured.
  
For each page of results, individual truck offer links were identified and collected using **XPath** or **CSS selectors**. These links were essential for accessing detailed truck information. Each truck offer page was parsed to extract the following key details:

- **Truck Specifications**: Mileage, fuel type, engine capacity, power, etc.
- **Seller Information**: Seller type (private or company), name, and time on the platform.
- **Price**: The listed price of the truck in PLN.
- **Location**: The precise location of the seller, including city or region.
- **Description**: The textual description provided by the seller, often containing additional details about the truck's condition, equipment, and history.

The dataset was segmented into **light**, **medium**, and **heavy** commercial vehicles (*LCV*, *MCV*, *HCV*) categories based on predefined thresholds based on engine capacity. This segmentation allowed us to tailor the analysis to the unique pricing dynamics of each category. By integrating these methods, we developed a detailed understanding of how different factors contribute to truck pricing in the market.

## **Raw Data**  

<div style="text-align: justify">
This file contains the data exactly as it was scraped, including all **inconsistencies**, **missing values**, and **HTML tags** intact. This step ensures that the original data is preserved for verification or reprocessing if needed.
</div>

## **Cleaned Data**  

The cleaned dataset consists of **2,172 rows** and **24 columns**, containing information on truck listings from an online marketplace. The data was preprocessed in the **`munging.R`** script, which handled missing values, standardized formats, and derived additional numerical features for easier analysis.  

### **Key Features in the Dataset**  

#### **Basic Information**  
- `offer_name` *(chr)*: The title of the truck listing, which typically includes the brand, model, and other specifications.  
- `production_year` *(int)*: The manufacturing year of the truck, which allows us to compute the age of the vehicle.  
- `price` *(chr → int: price_num)*: The listed price of the truck in **PLN** (Polish Złoty). Prices were cleaned by removing spaces and converting them into numerical format.  
- `mileage_km` *(chr → int: mileage_km_num)*: The total distance traveled by the truck, originally stored as a string with "km" and converted into numeric form.  

#### **Vehicle Specifications**  
- `vehicle_brand` *(chr)*: The manufacturer of the truck (e.g., **Mercedes-Benz, Volvo, Scania**).  
- `vehicle_model` *(chr)*: The specific model of the truck.  
- `fuel_type` *(chr)*: The type of fuel the truck uses (e.g., **Diesel**). Almost all listings use **Diesel**, making it a homogeneous feature.  
- `transmission` *(chr)*: The type of gearbox (**Manualna** = manual, **Automatyczna** = automatic).  
- `engine_capacity` *(chr → int: engine_capacity_num)*: The engine size in cubic centimeters (cm³). Extracted and converted into numeric format for analysis.  
- `power` *(chr → int: power_num)*: The engine power in **KM (Kilowatts/horsepower)**. This value was cleaned and converted into numerical format.  
- `weight_kg` *(int → int: weight_kg_num)*: The truck's weight in **kg**, available for a subset of listings.  

#### **Seller Information**  
- `seller_name` *(chr)*: The name of the seller, either an individual or a dealership/company.  
- `seller_type` *(chr)*: The type of seller (**"Osoba prywatna"** = private individual, **"Firma"** = company). Some values were missing and require further analysis.  
- `seller_time_on_site` *(chr)*: The duration the seller has been active on the platform, useful for assessing credibility.  

#### **Location & Origin**  
- `country_of_origin` *(chr)*: The country where the truck was originally registered (e.g., **Polska, Niemcy, Finlandia**). Many entries are missing, which suggests that this field may not always be provided.  
- `location` *(chr)*: The seller’s location, often including city and region within Poland.  

#### **Derived Features (Numeric Conversions)** 
- `years` *(int)*: The age of the vehicle, derived from `production_year` by subtracting from the current year.  
 
  
# Model description
<div style="text-align: justify">
To analyze the factors affecting truck prices across various weight categories, we applied a combination of machine learning models and data analysis techniques.  
  
Our primary method was **Random Forest**, an ensemble learning algorithm well-suited for capturing complex, non-linear interactions between variables. This model was utilized to determine feature importance, shedding light on which attributes, such as engine capacity, vehicle age, brand, and condition, played the most critical roles in determining truck prices.

In addition, **Linear Regression** was used as a baseline model to assess how specific factors influence pricing. This approach offered a straightforward interpretation of relationships between variables, particularly for continuous predictors like engine capacity and truck age. To further support the analysis, we performed **Correlation Studies** to measure the strength and direction of relationships between key features and truck prices.
</div>

# Obtained Results

## Results from model

## Analysis and Insights

```{r}
library(ggplot2)
library(rvest)
library(dplyr)
library(stringi)
library(tidyverse)
cleaned_data <- read.csv("cleaned_truck_market_data.csv")
glimpse(cleaned_data)
```

### Distribution of truck production years
```{r}
ggplot(cleaned_data, aes(x = as.numeric(production_year))) +
  geom_histogram(binwidth = 1, fill = "darkred", alpha = 0.7) +
  labs(title = "Distribution of Truck Production Years",
       x = "Year of Production",
       y = "Count") +
  theme_minimal()
```

***Key Insights:*** From the boxplot we can observe something similar to a normal distribution, where the mean value, where more trucks were produced, are between 2010 and 2015.

### Top 10 brands by frequency
```{r}
library(ggplot2)
library(dplyr)

total_count <- cleaned_data %>%
  count() %>%
  pull(n)

top_brands <- cleaned_data %>%
  count(vehicle_brand, sort = TRUE) %>%
  filter(vehicle_brand != "Inny") %>%
  top_n(10) %>%
  mutate(percentage = n / total_count * 100)

ggplot(top_brands, aes(x = reorder(vehicle_brand, n), y = n, fill = n)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            position = position_stack(vjust = 0.5),
            size = 4, color = "white") +
  coord_flip() +
  scale_fill_gradient(low = "red", high = "darkred") + 
  labs(title = "Top 10 Truck Brands in the Market",
       x = "Brand",
       y = "Count") +
  theme_minimal()

```
  
***Key Insights:***


### Price distribution of Top 10 brands
```{r}
top_brands <- cleaned_data %>%
  count(vehicle_brand, sort = TRUE) %>%
  filter(vehicle_brand != "Inny") %>%
  slice_max(n, n = 10) %>%
  pull(vehicle_brand)

price_range <- cleaned_data %>%
  filter(vehicle_brand %in% top_brands, !is.na(price_num)) %>% 
  group_by(vehicle_brand) %>%
  summarise(min_price = min(price_num), max_price = max(price_num)) 

brand_order <- cleaned_data %>%
  count(vehicle_brand, sort = TRUE) %>%
  filter(vehicle_brand %in% top_brands) %>%
  arrange(desc(n)) %>% 
  pull(vehicle_brand)

price_range <- price_range %>%
  mutate(vehicle_brand = factor(vehicle_brand, levels = rev(brand_order))) 

ggplot(price_range, aes(x = vehicle_brand, y = min_price)) +
  geom_point(color = "red", size = 4) +
  geom_point(aes(y = max_price), color = "darkred", size = 4) +
  geom_segment(aes(xend = vehicle_brand, yend = max_price), color = "black", size = 1) +
  coord_flip() + 
  labs(title = "Price Range of Top 10 Truck Brands (Ordered by Frequency)",
       x = "Brand",
       y = "Price (PLN)") +
  theme_minimal() +
  theme(legend.position = "none")
```
  
***Key Insights:***


### Seller types
```{r}
ggplot(cleaned_data %>% filter(!is.na(seller_type)), aes(x = seller_type, fill = ..count..)) +  # Use ..count.. for fill color
  geom_bar(stat = "count", show.legend = FALSE) +
  geom_text(stat = "count", aes(label = ..count..), 
            position = position_stack(vjust = 0.5),  # Text inside the bars
            size = 5, color = "white") + 
  scale_fill_gradient(low = "red", high = "darkred") +  # Apply color gradient to the fill
  labs(title = "Distribution of Seller Types", 
       x = "Seller Type", 
       y = "Count") +
  theme_minimal()
```
  
***Key Insights:***


### Price Distribution by Vehicle Brand

This visualization shows how truck prices vary across different brands.
```{r}
top_10_brands <- cleaned_data %>%
  count(vehicle_brand, sort = TRUE) %>%
  filter(vehicle_brand != "Inny") %>%
  slice_head(n = 10) %>%
  pull(vehicle_brand)

filtered_data <- cleaned_data %>%
  filter(vehicle_brand %in% top_10_brands)

brand_order <- cleaned_data %>%
  count(vehicle_brand, sort = TRUE) %>%
  filter(vehicle_brand %in% top_10_brands) %>%
  arrange(desc(n)) %>%
  pull(vehicle_brand)

filtered_data <- filtered_data %>%
  mutate(vehicle_brand = factor(vehicle_brand, levels = brand_order))

ggplot(filtered_data, aes(x = vehicle_brand, 
                          y = as.numeric(str_replace(price, " ", "")))) +
  geom_boxplot(outlier.color = "darkred", fill = "pink") +
  labs(title = "Price Distribution by Top 10 Vehicle Brands", 
       x = "Brand", y = "Price (PLN)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
  
```{r}
ggplot(filtered_data, aes(x = vehicle_brand, 
                          y = as.numeric(str_replace(price, " ", "")))) +
  geom_violin(fill = "pink", color = "darkred", alpha = 0.7) +
  labs(title = "Price Distribution by Top 10 Vehicle Brands", 
       x = "Brand", y = "Price (PLN)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```  
  
***Key Insights:*** The boxplot and the violin plot illustrates the price distribution of the top 10 most common truck brands in the dataset. The median price for most brands appears to be relatively similar, except for Krone, which has a significantly lower price range. Brands like Mercedes-Benz, MAN, and Volvo exhibit a wider price distribution, with higher interquartile ranges and many extreme outliers. This suggests that these brands offer both budget-friendly and high-end models. Iveco and Renault also show a considerable spread but with fewer extreme outliers compared to Mercedes-Benz and Volvo. The presence of numerous red dots (outliers) across most brands indicates that some trucks are priced significantly higher than the majority, possibly due to special features, low mileage, or newer models.

### Years vs. Price
```{r}
ggplot(cleaned_data, aes(x = years, 
                         y = as.numeric(str_replace(price, " ", "")))) +
  geom_point(alpha = 0.6, color = "pink") +
  geom_smooth(method = "lm", color = "darkred", se = FALSE) +  # Adds a trend line
  labs(title = "Truck Price vs. Production Year", 
       x = "Production Year", y = "Price (PLN)") +
  theme_minimal()
```
  
***Key Insights:*** We can observe how the oldest the truck the lower the price and viceversa. Is interesting and maybe expected that it follows a decreasing linear distribution.


# Conclusions

# Sources
[^1]:   https://tlp.org.pl/wp-content/uploads/2023/07/raport-transport-drogowy-w-polsce-2023.pdf
[^2]:   https://www.trade.gov.pl/aktualnosci/polski-transport-to-europejska-potega/
[^3]:   https://stat.gov.pl/obszary-tematyczne/transport-i-lacznosc/transport/transport-drogowy-w-polsce-w-latach-2022-i-2023,6,8.html
[^4]:   https://www.otomoto.pl/ciezarowe/mazowieckie
[^5]:   https://afdc.energy.gov/data/10380
